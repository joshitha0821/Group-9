@startuml
title Sequence Diagram - Answering a Question

actor User
boundary "Web UI" as UI
control "ChatController" as CC
entity "CacheService" as Cache
entity "VectorSearchService" as Vector
control "GenAISQLGenerator" as GenAI
control "SQLValidator" as Validator
entity "QueryExecutor" as Exec
control "ReportService" as Report
entity "AuditLogger" as Audit

User -> UI : enterQuestion(nlText)
UI -> CC : submitQuestion(userId, nlText)

CC -> Cache : getDirect(hash(nlText))
alt Direct cache hit
  Cache --> CC : CacheEntry
  CC -> Audit : log(status="cache_hit")
  CC --> UI : Answer(fromCache=true, sql, chart, summary)
else Cache miss
  Cache --> CC : null
  CC -> Vector : search(embed(nlText), topK=1)
  alt Semantic match
    Vector --> CC : SimilarityMatch(answerRef)
    CC -> Audit : log(status="vector_hit")
    CC --> UI : Answer(fromCache=true, sql, chart, summary)
  else No semantic match
    Vector --> CC : null
    CC -> GenAI : generateSQL(nlText, schema)
    GenAI --> CC : sql
    CC -> Validator : validate(sql)
    alt Valid SQL
      Validator --> CC : ok
      CC -> Exec : execute(sql)
      Exec --> CC : dataset
      CC -> Report : build(dataset)
      Report --> CC : chart, summary
      CC -> Cache : put(hash, entry)
      CC -> Vector : upsert(nlText, answerRef)
      CC -> Audit : log(status="genai_success")
      CC --> UI : Answer(fromCache=false, sql, chart, summary)
    else Invalid SQL
      Validator --> CC : reject(reason)
      CC -> Audit : log(status="genai_sql_rejected")
      CC --> UI : error("Cannot execute unsafe SQL")
    end
  end
end

UI --> User : display(chart, summary, sql)

@enduml
