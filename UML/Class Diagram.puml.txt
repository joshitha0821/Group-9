@startuml
skinparam classAttributeIconSize 0

class ChatController {
  +submitQuestion(userId: String, nlText: String): Answer
  -normalize(text: String): String
  -hash(text: String): String
}

class CacheService {
  +getDirect(key: String): CacheEntry?
  +put(key: String, entry: CacheEntry): void
  +refreshExpired(now: DateTime): int
}

class VectorSearchService {
  +embed(text: String): Vector
  +search(vec: Vector, topK: int): SimilarityMatch?
  +upsert(text: String, ref: String): void
}

class GenAISQLGenerator {
  +generateSQL(prompt: Prompt): String
}

class SQLValidator {
  +validate(sql: String, policy: SQLPolicy): ValidationResult
}

class QueryExecutor {
  +execute(sql: String, conn: DBConnection): DataSet
}

class ReportService {
  +generateChart(ds: DataSet, spec: ChartSpec): Chart
  +summarize(ds: DataSet): String
}

class FeedbackService {
  +recordFeedback(userId: String, questionKey: String, vote: Vote): void
}

class AuditLogger {
  +log(event: AuditEvent): void
}

class DocumentStore {
  +addDocument(doc: Document): String
  +listDocuments(): List<Document>
}

class TrainingDataManager {
  +ingestDocument(docId: String): void
  +buildIndex(): void
}

class DBConnectionManager {
  +addConnection(cfg: DBConfig): String
  +getConnection(id: String): DBConnection
  +getSchema(id: String): DBSchema
}

class CacheEntry {
  +key: String
  +nlText: String
  +sql: String
  +chart: Chart
  +summary: String
  +createdAt: DateTime
  +expiresAt: DateTime
  +hits: int
}

class Answer {
  +sql: String
  +chart: Chart
  +summary: String
  +fromCache: boolean
}

class AuditEvent {
  +userId: String
  +action: String
  +status: String
  +latencyMs: long
  +timestamp: DateTime
}

enum Vote {
  APPROVE
  DISAPPROVE
}

ChatController --> CacheService
ChatController --> VectorSearchService
ChatController --> GenAISQLGenerator
ChatController --> SQLValidator
ChatController --> QueryExecutor
ChatController --> ReportService
ChatController --> AuditLogger
ChatController --> FeedbackService

TrainingDataManager --> DocumentStore
TrainingDataManager --> VectorSearchService
DBConnectionManager --> QueryExecutor
CacheService *-- CacheEntry
ChatController ..> Answer

@enduml
