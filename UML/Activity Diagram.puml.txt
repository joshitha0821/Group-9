@startuml
start

:User enters NL question;
:Normalize question (lowercase,\ntrim, remove punctuation);

if (Direct cache hit?) then (Yes)
  :Fetch cached answer O(1);
  :Render chart + summary + SQL;
  :Log audit event;
  stop
else (No)
  :Embed question (vector);
  if (Vector similarity match?) then (Yes)
    :Fetch best semantic match;
    :Return matched answer;
    :Log audit event;
    stop
  else (No)
    :Build prompt with schema\n+ policies + examples;
    :GenAI generates SQL;
    :Validate SQL (allowed tables,\nno DDL/DML, safe clauses);
    if (SQL valid?) then (Yes)
      :Execute SQL on DB;
      :Extract dataset;
      :Generate chart;
      :Generate NL summary;
      :Store answer in cache\n+ vector store;
      :Log audit event;
      stop
    else (No)
      :Return error + guidance;
      :Log audit event;
      stop
    endif
  endif
endif

@enduml
